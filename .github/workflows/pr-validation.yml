name: PR Validation & Auto-Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]

jobs:
  version-guard:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    name: Version & Changelog Guard

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure version is bumped for main-bound PRs
        run: |
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_VERSION=$(node -p "require('./package.json').version")
          BASE_VERSION=$(git show "$BASE_REF":package.json | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8')).version")

          echo "Base version: $BASE_VERSION"
          echo "Head version: $HEAD_VERSION"

          node -e '
          const parse = (v) => v.split(".").map((n) => Number(n));
          const base = parse(process.argv[1]);
          const head = parse(process.argv[2]);
          const valid = [base, head].every((arr) => arr.length === 3 && arr.every(Number.isFinite));
          if (!valid) {
            console.error("Invalid semver format. Expected MAJOR.MINOR.PATCH");
            process.exit(1);
          }
          const cmp = (a, b) => {
            for (let i = 0; i < 3; i += 1) {
              if (a[i] > b[i]) return 1;
              if (a[i] < b[i]) return -1;
            }
            return 0;
          };
          if (cmp(head, base) <= 0) {
            console.error(`Version bump required for PRs to main: base=${process.argv[1]} head=${process.argv[2]}`);
            process.exit(1);
          }
          ' "$BASE_VERSION" "$HEAD_VERSION"

      - name: Ensure changelog entry exists for new version
        run: |
          HEAD_VERSION=$(node -p "require('./package.json').version")
          if grep -q "^## \[$HEAD_VERSION\]" CHANGELOG.md; then
            echo "âœ… CHANGELOG.md contains entry for $HEAD_VERSION"
          else
            echo "âŒ CHANGELOG.md must contain header: ## [$HEAD_VERSION]"
            exit 1
          fi
  validate:
    runs-on: ubuntu-latest
    name: Code Quality & Tests

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run linting
        run: npm run lint
        continue-on-error: true

      - name: Check code formatting
        run: npm run format:check
        continue-on-error: true

      - name: Run unit tests
        run: npm test -- --coverage
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  copilot-validation:
    if: github.actor == 'Copilot' || contains(github.head_ref, 'copilot')
    runs-on: ubuntu-latest
    name: Copilot PR Validation

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$TITLE" =~ ^(\[WIP\]|\[feat\]|\[fix\]|\[docs\]|\[refactor\]|\[test\]) ]]; then
            echo "â„¹ï¸ PR title should start with label like [feat], [fix], [docs], etc."
          fi

      - name: Validate issue reference
        run: |
          BODY="${{ github.event.pull_request.body }}"
          if [[ ! "$BODY" =~ Closes\ #|Fixes\ #|Resolves\ # ]]; then
            echo "âš ï¸ PR should reference an issue (Closes #N, Fixes #N, etc.)"
          fi

      - name: Check for CHANGELOG entry
        run: |
          if git diff origin/main HEAD -- CHANGELOG.md | grep -q "## \["; then
            echo "âœ… CHANGELOG.md has been updated"
          else
            echo "â„¹ï¸ Consider updating CHANGELOG.md"
          fi

      - name: Verify test coverage
        run: |
          if [[ -f coverage/coverage-summary.json ]]; then
            COVERAGE=$(grep -o '"lines"[^}]*' coverage/coverage-summary.json | head -1 | grep -o '[0-9.]*' | head -1)
            echo "Test coverage: ${COVERAGE}%"
          fi

  auto-comment:
    if: github.event.action == 'opened' && (github.actor == 'Copilot' || contains(github.head_ref, 'copilot'))
    runs-on: ubuntu-latest
    name: Auto-Comment on Copilot PR

    steps:
      - uses: actions/checkout@v4

      - name: Post validation checklist
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## ğŸ¤– Copilotå·¥ä½œæµéªŒè¯æ¸…å•',
              '',
              '### è‡ªåŠ¨æ£€æŸ¥',
              '- âœ“ ä»£ç æ ¼å¼ä¸Linting',
              '- âœ“ å•å…ƒæµ‹è¯•æ‰§è¡Œ',
              '- âœ“ TypeScriptç¼–è¯‘',
              '',
              '### æ‰‹åŠ¨æ ¸æŸ¥é¡¹',
              '- [ ] PRæ ‡é¢˜åŒ…å«æ ‡ç­¾ ([feat], [fix], [docs] ç­‰)',
              '- [ ] PRæè¿°æ¸…æ™°ï¼Œè¯´æ˜ç›®çš„å’Œæ”¹åŠ¨',
              '- [ ] æ‰€æœ‰issueéƒ½æ­£ç¡®å…³è”',
              '- [ ] æ²¡æœ‰merge conflicts',
              '- [ ] æ²¡æœ‰ console.log æˆ– debugger è¯­å¥',
              '- [ ] æ–°ä»£ç æœ‰ç›¸åº”çš„æµ‹è¯•',
              '- [ ] æ›´æ–°äº†CHANGELOG.md (å¦‚æœæ˜¯æ–°ç‰ˆæœ¬)',
              '',
              '### ä»£ç†å•†æ£€æŸ¥é¡¹',
              '- [ ] ä»£ç æŒ‰ç…§é¡¹ç›®è§„èŒƒç¼–å†™',
              '- [ ] å›½é™…åŒ–æ”¯æŒæ­£ç¡®',
              '- [ ] æ²¡æœ‰å®‰å…¨éšæ‚£',
              '- [ ] IDEç‰¹å®šçš„ä»£ç /é…ç½®è¢«æ’é™¤',
              '',
              '---',
              '> æç¤º: ä¸»è¦è´¡çŒ®è€…å°†åœ¨åˆå¹¶å‰è¿›è¡Œæœ€åå®¡æŸ¥'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            })
